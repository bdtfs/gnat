{{if .}}
<div class="list">
    {{range .}}
    <div class="run-card {{if eq .status "running"}}pulsing{{end}}">
    <div class="run-header">
        <div class="run-title">
            <span class="status status-{{.status}}">{{.status}}</span>
            <span class="run-id">{{.id}}</span>
        </div>
        <div class="run-actions">
            <button class="btn btn-sm"
                    hx-get="/runs/{{.id}}"
                    hx-target="#run-detail-modal"
                    onclick="showModal()">
                Details
            </button>
            {{if eq .status "running"}}
            <button class="btn btn-sm btn-warning"
                    hx-post="/runs/{{.id}}/cancel"
                    hx-confirm="Cancel this run?">
                â¸ Cancel
            </button>
            {{end}}
        </div>
    </div>

    <div class="run-timing">
        {{if .started_at}}
        <div class="timing-item">
            <span class="timing-label">Started:</span>
            <span class="timing-value">{{formatTime .started_at}}</span>
        </div>
        {{end}}
        {{if .elapsed}}
        <div class="timing-item">
            <span class="timing-label">Elapsed:</span>
            <span class="timing-value">{{formatDuration .elapsed}}</span>
        </div>
        {{end}}
    </div>

    {{if .stats}}
    <div class="run-stats">
        <div class="stat-box">
            <div class="stat-label">Requests</div>
            <div class="stat-value">{{.stats.total}}</div>
        </div>
        <div class="stat-box">
            <div class="stat-label">Success</div>
            <div class="stat-value stat-success">{{.stats.success}}</div>
        </div>
        <div class="stat-box">
            <div class="stat-label">Failed</div>
            <div class="stat-value {{if gt .stats.failed 0.0}}stat-error{{end}}">{{.stats.failed}}</div>
        </div>
        <div class="stat-box">
            <div class="stat-label">Avg Latency</div>
            <div class="stat-value">{{formatFloat .stats.avg_latency_ms}}ms</div>
        </div>
        <div class="stat-box">
            <div class="stat-label">P95</div>
            <div class="stat-value">{{formatFloat .stats.p95_latency_ms}}ms</div>
        </div>
        <div class="stat-box">
            <div class="stat-label">RPS</div>
            <div class="stat-value stat-primary">{{formatFloat .stats.rps}}</div>
        </div>
    </div>

    {{if eq .status "running"}}
    <div class="mini-chart-container">
        <canvas id="miniChart-{{.id}}" class="mini-chart"></canvas>
    </div>
    {{end}}
    {{end}}
</div>
{{end}}
</div>

<script>
    (function() {
        {{range .}}
        {{if and .stats (eq .status "running")}}
        (function() {
            const canvas = document.getElementById('miniChart-{{.id}}');
            if (!canvas) return;

            const existingChart = Chart.getChart(canvas);
            if (existingChart) {
                existingChart.destroy();
            }

            const stats = {{.stats | json}};

            new Chart(canvas, {
                type: 'line',
                data: {
                    labels: ['Min', 'P50', 'P90', 'P95', 'P99'],
                    datasets: [{
                        label: 'Latency (ms)',
                        data: [
                            stats.min_latency_ms,
                            stats.p50_latency_ms,
                            stats.p90_latency_ms,
                            stats.p95_latency_ms,
                            stats.p99_latency_ms
                        ],
                        borderColor: '#00d4aa',
                        backgroundColor: 'rgba(0, 212, 170, 0.1)',
                        tension: 0.4,
                        fill: true,
                        pointRadius: 3,
                        pointBackgroundColor: '#00d4aa',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: { enabled: true }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: { color: '#252525', drawBorder: false },
                            ticks: { color: '#666', font: { size: 10 } }
                        },
                        x: {
                            grid: { display: false },
                            ticks: { color: '#666', font: { size: 10 } }
                        }
                    }
                }
            });
        })();
        {{end}}
        {{end}}
    })();
</script>
{{else}}
<div class="empty-state">
    <p>No active runs. Start a test to begin.</p>
</div>
{{end}}